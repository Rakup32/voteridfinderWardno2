import pandas as pd
import streamlit as st

# Set page configuration
st.set_page_config(
    page_title="‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§∏‡•Ç‡§ö‡•Ä ‡§ñ‡•ã‡§ú ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä",
    page_icon="üó≥Ô∏è",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for better styling
st.markdown("""
    <style>
    .main {
        padding: 0rem 1rem;
    }
    .stDataFrame {
        border: 2px solid #f0f2f6;
        border-radius: 5px;
    }
    h1 {
        color: #FF4B4B;
        text-align: center;
        padding: 1rem 0;
    }
    .search-box {
        background-color: #f0f2f6;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    </style>
    """, unsafe_allow_html=True)

# Title
st.title("üó≥Ô∏è ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§∏‡•Ç‡§ö‡•Ä ‡§ñ‡•ã‡§ú ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä")
st.markdown("**Voter List Search System**")
st.markdown("---")

# Load data
@st.cache_data
def load_data():
    df = pd.read_excel('voterlist.xlsx')
    return df

try:
    df = load_data()
    
    # Sidebar for search options
    st.sidebar.header("‡§ñ‡•ã‡§ú ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™")
    
    search_option = st.sidebar.selectbox(
        "‡§ñ‡•ã‡§ú ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:",
        ["‡§∏‡§¨‡•à ‡§°‡§æ‡§ü‡§æ ‡§π‡•á‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", "‡§Æ‡§§‡§¶‡§æ‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", "‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", 
         "‡§≤‡§ø‡§ô‡•ç‡§ó‡§¨‡§æ‡§ü ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", "‡§â‡§Æ‡•á‡§∞ ‡§¶‡§æ‡§Ø‡§∞‡§æ‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"]
    )
    
    # Display based on search option
    if search_option == "‡§∏‡§¨‡•à ‡§°‡§æ‡§ü‡§æ ‡§π‡•á‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç":
        st.subheader("‡§∏‡§Æ‡•ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§∏‡•Ç‡§ö‡•Ä")
        st.dataframe(df, use_container_width=True, height=600)
        
        col1, col2 = st.columns([3, 1])
        with col1:
            st.info(f"‡§ï‡•Å‡§≤ ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: {len(df)}")
        with col2:
            # Download button
            csv = df.to_csv(index=False).encode('utf-8-sig')
            st.download_button(
                label="üì• CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç",
                data=csv,
                file_name="voter_list.csv",
                mime="text/csv"
            )
    
    elif search_option == "‡§Æ‡§§‡§¶‡§æ‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç":
        st.subheader("‡§Æ‡§§‡§¶‡§æ‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
        search_name = st.text_input("‡§Æ‡§§‡§¶‡§æ‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:", "", key="name_search")
        
        if search_name:
            filtered_df = df[df['‡§Æ‡§§‡§¶‡§æ‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ'].str.contains(search_name, case=False, na=False)]
            
            if not filtered_df.empty:
                col1, col2 = st.columns([3, 1])
                with col1:
                    st.success(f"{len(filtered_df)} ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§≠‡•á‡§ü‡§ø‡§Ø‡•ã")
                with col2:
                    csv = filtered_df.to_csv(index=False).encode('utf-8-sig')
                    st.download_button(
                        label="üì• ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°",
                        data=csv,
                        file_name=f"search_results_{search_name}.csv",
                        mime="text/csv"
                    )
                st.dataframe(filtered_df, use_container_width=True, height=400)
            else:
                st.warning("‡§ï‡•Å‡§®‡•à ‡§™‡§®‡§ø ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§≠‡•á‡§ü‡§ø‡§è‡§®")
        else:
            st.info("‡§ñ‡•ã‡§ú‡•ç‡§®‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
    
    elif search_option == "‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç":
        st.subheader("‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
        search_number = st.text_input("‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:", "")
        
        if search_number:
            try:
                search_num = int(search_number)
                filtered_df = df[df['‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§®‡§Ç'] == search_num]
                
                if not filtered_df.empty:
                    st.success("‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§≠‡•á‡§ü‡§ø‡§Ø‡•ã")
                    st.dataframe(filtered_df, use_container_width=True, height=200)
                else:
                    st.warning("‡§ï‡•Å‡§®‡•à ‡§™‡§®‡§ø ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§≠‡•á‡§ü‡§ø‡§è‡§®")
            except ValueError:
                st.error("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§Ç‡§¨‡§∞ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
        else:
            st.info("‡§ñ‡•ã‡§ú‡•ç‡§®‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
    
    elif search_option == "‡§≤‡§ø‡§ô‡•ç‡§ó‡§¨‡§æ‡§ü ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç":
        st.subheader("‡§≤‡§ø‡§ô‡•ç‡§ó‡§¨‡§æ‡§ü ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
        
        unique_genders = df['‡§≤‡§ø‡§ô‡•ç‡§ó'].unique().tolist()
        selected_gender = st.selectbox("‡§≤‡§ø‡§ô‡•ç‡§ó ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:", ["‡§∏‡§¨‡•à"] + unique_genders)
        
        if selected_gender == "‡§∏‡§¨‡•à":
            filtered_df = df
        else:
            filtered_df = df[df['‡§≤‡§ø‡§ô‡•ç‡§ó'] == selected_gender]
        
        st.success(f"{len(filtered_df)} ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§≠‡•á‡§ü‡§ø‡§Ø‡•ã")
        st.dataframe(filtered_df, use_container_width=True, height=500)
    
    elif search_option == "‡§â‡§Æ‡•á‡§∞ ‡§¶‡§æ‡§Ø‡§∞‡§æ‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç":
        st.subheader("‡§â‡§Æ‡•á‡§∞ ‡§¶‡§æ‡§Ø‡§∞‡§æ‡§¨‡§æ‡§ü ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç")
        
        col1, col2 = st.columns(2)
        
        with col1:
            min_age = st.number_input("‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§â‡§Æ‡•á‡§∞:", min_value=0, max_value=150, value=18)
        
        with col2:
            max_age = st.number_input("‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§â‡§Æ‡•á‡§∞:", min_value=0, max_value=150, value=100)
        
        filtered_df = df[(df['‡§â‡§Æ‡•á‡§∞(‡§µ‡§∞‡•ç‡§∑)'] >= min_age) & (df['‡§â‡§Æ‡•á‡§∞(‡§µ‡§∞‡•ç‡§∑)'] <= max_age)]
        
        st.success(f"{len(filtered_df)} ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§≠‡•á‡§ü‡§ø‡§Ø‡•ã (‡§â‡§Æ‡•á‡§∞: {min_age} - {max_age} ‡§µ‡§∞‡•ç‡§∑)")
        st.dataframe(filtered_df, use_container_width=True, height=500)
    
    # Statistics in sidebar
    st.sidebar.markdown("---")
    st.sidebar.subheader("‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï")
    st.sidebar.metric("‡§ï‡•Å‡§≤ ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ", len(df))
    
    if '‡§≤‡§ø‡§ô‡•ç‡§ó' in df.columns:
        st.sidebar.write("‡§≤‡§ø‡§ô‡•ç‡§ó ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞:")
        gender_counts = df['‡§≤‡§ø‡§ô‡•ç‡§ó'].value_counts()
        for gender, count in gender_counts.items():
            st.sidebar.write(f"- {gender}: {count}")
    
    if '‡§â‡§Æ‡•á‡§∞(‡§µ‡§∞‡•ç‡§∑)' in df.columns:
        st.sidebar.metric("‡§î‡§∏‡§§ ‡§â‡§Æ‡•á‡§∞", f"{df['‡§â‡§Æ‡•á‡§∞(‡§µ‡§∞‡•ç‡§∑)'].mean():.1f} ‡§µ‡§∞‡•ç‡§∑")

except FileNotFoundError:
    st.error("‚ö†Ô∏è voterlist.xlsx ‡§´‡§æ‡§á‡§≤ ‡§≠‡•á‡§ü‡§ø‡§è‡§®! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡•ã ‡§´‡§æ‡§á‡§≤ ‡§Ø‡§π‡•Ä ‡§´‡•ã‡§≤‡•ç‡§°‡§∞‡§Æ‡§æ ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§")
except Exception as e:
    st.error(f"‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: {str(e)}")

# Footer
st.markdown("---")
st.markdown("**‡§®‡•ã‡§ü:** ‡§Ø‡•ã ‡§è‡§ï ‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§∏‡•Ç‡§ö‡•Ä ‡§ñ‡•ã‡§ú ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§π‡•ã‡•§ ‡§∏‡§¨‡•à ‡§°‡§æ‡§ü‡§æ ‡§Æ‡•Ç‡§≤ Excel ‡§´‡§æ‡§á‡§≤‡§¨‡§æ‡§ü ‡§≤‡§ø‡§á‡§è‡§ï‡•ã ‡§õ‡•§")
